name: "Terraform CI"

on:
  pull_request:
    branches:
      - main
    paths:
      - "terraform/**"
      - ".github/workflows/terraform_ci.yaml"

jobs:
  terraform-static-analysis:
    permissions:
      contents: read
      security-events: write # for github/codeql-action/upload-sarif to upload SARIF results
      pull-requests: write
    env:
      GH_TOKEN: ${{ secrets.REPO_TOKEN }}
    name: "🛡️Terraform Static Analysis"
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - uses: actions/cache@v3
        name: Cache plugin dir
        with:
          path: ~/.tflint.d/plugins
          key: ubuntu-latest-tflint-${{ hashFiles('.tflint.hcl') }}

      - uses: terraform-linters/setup-tflint@v3
        name: Setup TFLint
        with:
          tflint_version: latest

      - name: Init TFLint
        run: tflint --init --config config/tflint/tflint.aws.hcl

      - name: Run TFLint
        run: tflint --disable-rule=terraform_unused_declarations --chdir terraform --format compact > tflint.txt

      - name: Checkov GitHub Action
        uses: bridgecrewio/checkov-action@v12
        if: success() || failure()
        with:
          # This will add both a CLI output to the console and create a results.sarif file
          output_format: cli, github_failed_only
          output_file_path: console,checkov.txt

      - name: Comment TFLint output on PR
        if: success() || failure()
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body-file=tflint.txt

      - name: Comment Checkov output on PR
        if: success() || failure()
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body-file=checkov.txt